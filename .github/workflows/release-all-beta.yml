name: Release Backend & Frontend (Beta)

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # 1. Letzte Beta-Release-Tags ermitteln
      - name: Letzten Beta-Backend-Tag ermitteln
        id: last_backend
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          TAG=$(gh api repos/BBessler/Solarmanager/releases --jq '[.[] | select(.prerelease == true) | select(.tag_name | startswith("beta-backend-"))][0].tag_name // empty' 2>/dev/null || true)
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Letzter Beta-Backend-Tag: ${TAG:-keiner}"

      - name: Letzten Beta-Frontend-Tag ermitteln
        id: last_frontend
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          TAG=$(gh api repos/BBessler/Solarmanager/releases --jq '[.[] | select(.prerelease == true) | select(.tag_name | startswith("beta-frontend-"))][0].tag_name // empty' 2>/dev/null || true)
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Letzter Beta-Frontend-Tag: ${TAG:-keiner}"

      # 2. Commit-Historie aus privaten Repos holen (seit letztem Beta-Release)
      - name: Backend-Commits sammeln
        id: backend_commits
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          LAST_TAG="${{ steps.last_backend.outputs.tag }}"

          if [ -n "$LAST_TAG" ]; then
            SINCE=$(gh api repos/BBessler/Solarmanager/releases --jq \
              "[.[] | select(.tag_name == \"$LAST_TAG\")][0].created_at // empty" 2>/dev/null || true)
          fi

          if [ -n "$SINCE" ]; then
            COMMITS=$(gh api "repos/BBessler/Solarmanager_Backend/commits?since=$SINCE&per_page=100" \
              --jq '[.[] | "- " + (.commit.message | split("\n")[0])] | join("\n")' 2>/dev/null || true)
          else
            COMMITS=$(gh api "repos/BBessler/Solarmanager_Backend/commits?per_page=20" \
              --jq '[.[] | "- " + (.commit.message | split("\n")[0])] | join("\n")' 2>/dev/null || true)
          fi

          if [ -z "$COMMITS" ]; then
            COMMITS="- Keine neuen Commits"
          fi

          {
            echo "changelog<<CHANGELOG_EOF"
            echo "$COMMITS"
            echo "CHANGELOG_EOF"
          } >> $GITHUB_OUTPUT

      - name: Frontend-Commits sammeln
        id: frontend_commits
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          LAST_TAG="${{ steps.last_frontend.outputs.tag }}"

          if [ -n "$LAST_TAG" ]; then
            SINCE=$(gh api repos/BBessler/Solarmanager/releases --jq \
              "[.[] | select(.tag_name == \"$LAST_TAG\")][0].created_at // empty" 2>/dev/null || true)
          fi

          if [ -n "$SINCE" ]; then
            COMMITS=$(gh api "repos/BBessler/solarmanager_Frontend/commits?since=$SINCE&per_page=100" \
              --jq '[.[] | "- " + (.commit.message | split("\n")[0])] | join("\n")' 2>/dev/null || true)
          else
            COMMITS=$(gh api "repos/BBessler/solarmanager_Frontend/commits?per_page=20" \
              --jq '[.[] | "- " + (.commit.message | split("\n")[0])] | join("\n")' 2>/dev/null || true)
          fi

          if [ -z "$COMMITS" ]; then
            COMMITS="- Keine neuen Commits"
          fi

          {
            echo "changelog<<CHANGELOG_EOF"
            echo "$COMMITS"
            echo "CHANGELOG_EOF"
          } >> $GITHUB_OUTPUT

      # 3. Beta-Release-Workflows triggern
      - name: Backend-Beta-Release triggern
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          gh api repos/BBessler/Solarmanager_Backend/actions/workflows/release-test.yaml/dispatches \
            -f ref=master

      # 4. Frontend-Beta-Release triggern
      - name: Frontend-Beta-Release triggern
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          gh api repos/BBessler/solarmanager_Frontend/actions/workflows/release-test.yml/dispatches \
            -f ref=master

      # 5. Auf Abschluss warten
      - name: Auf Backend-Workflow warten
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          echo "Warte 15 Sekunden bis Workflow-Run sichtbar ist..."
          sleep 15

          for i in $(seq 1 60); do
            RUN=$(gh api "repos/BBessler/Solarmanager_Backend/actions/workflows/release-test.yaml/runs?per_page=1" \
              --jq '.workflow_runs[0] | "\(.id) \(.status) \(.conclusion // "null")"')

            RUN_ID=$(echo "$RUN" | awk '{print $1}')
            STATUS=$(echo "$RUN" | awk '{print $2}')
            CONCLUSION=$(echo "$RUN" | awk '{print $3}')

            echo "Backend-Beta-Run $RUN_ID: status=$STATUS conclusion=$CONCLUSION (Versuch $i/60)"

            if [ "$STATUS" = "completed" ]; then
              if [ "$CONCLUSION" = "success" ]; then
                echo "Backend-Beta-Release erfolgreich!"
                break
              else
                echo "::error::Backend-Beta-Release fehlgeschlagen: $CONCLUSION"
                exit 1
              fi
            fi

            sleep 15
          done

          if [ "$STATUS" != "completed" ]; then
            echo "::error::Backend-Beta-Release Timeout nach 15 Minuten"
            exit 1
          fi

      - name: Auf Frontend-Workflow warten
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          for i in $(seq 1 60); do
            RUN=$(gh api "repos/BBessler/solarmanager_Frontend/actions/workflows/release-test.yml/runs?per_page=1" \
              --jq '.workflow_runs[0] | "\(.id) \(.status) \(.conclusion // "null")"')

            RUN_ID=$(echo "$RUN" | awk '{print $1}')
            STATUS=$(echo "$RUN" | awk '{print $2}')
            CONCLUSION=$(echo "$RUN" | awk '{print $3}')

            echo "Frontend-Beta-Run $RUN_ID: status=$STATUS conclusion=$CONCLUSION (Versuch $i/60)"

            if [ "$STATUS" = "completed" ]; then
              if [ "$CONCLUSION" = "success" ]; then
                echo "Frontend-Beta-Release erfolgreich!"
                break
              else
                echo "::error::Frontend-Beta-Release fehlgeschlagen: $CONCLUSION"
                exit 1
              fi
            fi

            sleep 15
          done

          if [ "$STATUS" != "completed" ]; then
            echo "::error::Frontend-Beta-Release Timeout nach 15 Minuten"
            exit 1
          fi

      # 6. Release-Notes mit Changelog aktualisieren
      - name: Backend-Release-Notes aktualisieren
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          VERSION=$(date +'%Y.%m.%d')
          TAG="beta-backend-$VERSION"

          RELEASE_ID=$(gh api "repos/BBessler/Solarmanager/releases/tags/$TAG" --jq '.id' 2>/dev/null || true)

          if [ -z "$RELEASE_ID" ]; then
            echo "::warning::Beta-Backend-Release $TAG nicht gefunden, ueberspringe Notes-Update"
            exit 0
          fi

          BODY="## Beta Backend Änderungen
          ${{ steps.backend_commits.outputs.changelog }}"

          BODY=$(echo "$BODY" | sed 's/^          //')

          gh api "repos/BBessler/Solarmanager/releases/$RELEASE_ID" \
            -X PATCH \
            -f body="$BODY"

          echo "Beta-Backend-Release-Notes aktualisiert"

      - name: Frontend-Release-Notes aktualisieren
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          VERSION=$(date +'%Y.%m.%d')
          TAG="beta-frontend-$VERSION"

          RELEASE_ID=$(gh api "repos/BBessler/Solarmanager/releases/tags/$TAG" --jq '.id' 2>/dev/null || true)

          if [ -z "$RELEASE_ID" ]; then
            echo "::warning::Beta-Frontend-Release $TAG nicht gefunden, ueberspringe Notes-Update"
            exit 0
          fi

          BODY="## Beta Frontend Änderungen
          ${{ steps.frontend_commits.outputs.changelog }}"

          BODY=$(echo "$BODY" | sed 's/^          //')

          gh api "repos/BBessler/Solarmanager/releases/$RELEASE_ID" \
            -X PATCH \
            -f body="$BODY"

          echo "Beta-Frontend-Release-Notes aktualisiert"

      - name: Zusammenfassung
        run: |
          VERSION=$(date +'%Y.%m.%d')
          echo "## Beta Release $VERSION abgeschlossen" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Änderungen" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.backend_commits.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Änderungen" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.frontend_commits.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
